# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼

## æ©Ÿå¯†æƒ…å ±ä¿è­·

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€æ©Ÿå¯†æƒ…å ±ï¼ˆAPIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰ã®èª¤ã‚³ãƒŸãƒƒãƒˆã‚’é˜²ããŸã‚ã€å¤šå±¤é˜²å¾¡ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### ğŸ›¡ï¸ å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹é˜²å¾¡ç­–

#### 1. .gitignore ã«ã‚ˆã‚‹é™¤å¤–

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè‡ªå‹•çš„ã«Gitç®¡ç†ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™ï¼š

- `terraform/terraform.tfvars` - Terraformå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«
- `.env`, `.env.*` - ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«
- `.dev.vars` - Wrangleré–‹ç™ºç”¨å¤‰æ•°
- `*secret*`, `*private*`, `*credentials*` - æ©Ÿå¯†æƒ…å ±ã‚’ç¤ºã™ãƒ•ã‚¡ã‚¤ãƒ«å
- `*.pem`, `*.key`, `*.p12` - è¨¼æ˜æ›¸ãƒ»éµãƒ•ã‚¡ã‚¤ãƒ«
- `*apikey*`, `*token*` - APIã‚­ãƒ¼ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«å

è©³ç´°: `.gitignore`

#### 2. Pre-commit ãƒ•ãƒƒã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰

ã‚³ãƒŸãƒƒãƒˆå‰ã«è‡ªå‹•çš„ã«Gitleaksã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:**

```bash
# Gitleaksã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆmacOSï¼‰
brew install gitleaks

# pnpm installã§è‡ªå‹•çš„ã«HuskyãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™
pnpm install
```

**å‹•ä½œ:**

- ã‚³ãƒŸãƒƒãƒˆæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
- æ©Ÿå¯†æƒ…å ±ã‚’æ¤œå‡ºã™ã‚‹ã¨ã€ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
- èª¤æ¤œçŸ¥ã®å ´åˆã¯ `.gitleaksignore` ã«è¿½åŠ 

#### 3. GitHub Actionsï¼ˆCIï¼‰

ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã€Gitleaksã«ã‚ˆã‚‹ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

**è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:** `.github/workflows/security-scan.yml`

ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§æ¤œå‡ºã—ã¾ã™ã€‚

#### 4. Gitleaksè¨­å®š

ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã¨è¨±å¯ãƒªã‚¹ãƒˆã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

**è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:**

- `.gitleaks.toml` - Gitleaksè¨­å®š
- `.gitleaksignore` - èª¤æ¤œçŸ¥ã®é™¤å¤–ãƒªã‚¹ãƒˆ

### ğŸ“ æ©Ÿå¯†æƒ…å ±ã‚’æ‰±ã†éš›ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### Terraformå¤‰æ•°ã®ç®¡ç†

```bash
# 1. ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
cp terraform/terraform.tfvars.example terraform/terraform.tfvars

# 2. å®Ÿéš›ã®å€¤ã‚’è¨˜å…¥ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯Gitç®¡ç†ã•ã‚Œã¾ã›ã‚“ï¼‰
vim terraform/terraform.tfvars
```

#### ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†

```bash
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆGitç®¡ç†ã•ã‚Œã¾ã›ã‚“ï¼‰
echo "CLOUDFLARE_API_TOKEN=your-token-here" > .env
```

#### Cloudflareè¨­å®š

```bash
# Wranglerç”¨ã®ç’°å¢ƒå¤‰æ•°
echo "CLOUDFLARE_ACCOUNT_ID=your-account-id" > .dev.vars
```

### ğŸš¨ ã‚‚ã—æ©Ÿå¯†æƒ…å ±ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã—ã¾ã£ãŸå ´åˆ

#### ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ã¿ã‚³ãƒŸãƒƒãƒˆã—ãŸå ´åˆ

```bash
# æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–ã‚Šæ¶ˆã™
git reset --soft HEAD~1

# æ©Ÿå¯†æƒ…å ±ã‚’å‰Šé™¤
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã¾ãŸã¯å‰Šé™¤

# å†åº¦ã‚³ãƒŸãƒƒãƒˆ
git add .
git commit -m "Fix: Remove sensitive data"
```

#### ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã—ã¾ã£ãŸå ´åˆ

**é‡è¦:** å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã€æ©Ÿå¯†æƒ…å ±ã¯æ—¢ã«æ¼æ´©ã—ã¦ã„ã¾ã™ã€‚ã™ãã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚

1. **ãƒˆãƒ¼ã‚¯ãƒ³/ã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–**
   - Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
   - æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ

2. **å±¥æ­´ã‹ã‚‰å‰Šé™¤**
   ```bash
   # BFG Repo-Cleanerã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
   brew install bfg
   bfg --delete-files terraform.tfvars
   bfg --replace-text passwords.txt

   # Gitã®ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
   git reflog expire --expire=now --all
   git gc --prune=now --aggressive

   # å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥
   git push origin --force --all
   ```

3. **ãƒãƒ¼ãƒ ã«é€šçŸ¥**
   - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«`git pull --rebase`ã‚’ä¾é ¼

### ğŸ” æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³

ã„ã¤ã§ã‚‚æ‰‹å‹•ã§ã‚¹ã‚­ãƒ£ãƒ³ã§ãã¾ã™ï¼š

```bash
# ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³
gitleaks detect --verbose

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚¨ãƒªã‚¢ã®ã¿ã‚¹ã‚­ãƒ£ãƒ³
gitleaks protect --staged

# ç‰¹å®šã®ã‚³ãƒŸãƒƒãƒˆç¯„å›²ã‚’ã‚¹ã‚­ãƒ£ãƒ³
gitleaks detect --log-opts="main..feature-branch"
```

### ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Gitleaks Documentation](https://github.com/gitleaks/gitleaks)
- [Husky Documentation](https://typicode.github.io/husky/)
- [Cloudflare API Tokens](https://developers.cloudflare.com/fundamentals/api/get-started/create-token/)

### ğŸ› å•é¡Œå ±å‘Š

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯ã€å…¬é–‹ã®issueã§ã¯ãªãã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼ã«ç›´æ¥é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
